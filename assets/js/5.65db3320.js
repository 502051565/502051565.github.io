(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{1120:function(s,t,a){"use strict";a.r(t);var n=a(17),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"_1-熔断降级限流"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-熔断降级限流"}},[s._v("#")]),s._v(" 1 熔断降级限流")]),s._v(" "),n("p"),n("div",{staticClass:"table-of-contents"},[n("ul",[n("li",[n("a",{attrs:{href:"#_1-熔断降级限流"}},[s._v("1 熔断降级限流")]),n("ul",[n("li",[n("a",{attrs:{href:"#_1-1-什么是熔断"}},[s._v("1.1 什么是熔断")])]),n("li",[n("a",{attrs:{href:"#_1-2-什么是降级"}},[s._v("1.2 什么是降级")])]),n("li",[n("a",{attrs:{href:"#_1-3-异同"}},[s._v("1.3 异同")])]),n("li",[n("a",{attrs:{href:"#_1-4-什么是限流"}},[s._v("1.4 什么是限流")])])])]),n("li",[n("a",{attrs:{href:"#_2-sentinel简介"}},[s._v("2. Sentinel简介")]),n("ul",[n("li",[n("a",{attrs:{href:"#_2-1-特征"}},[s._v("2.1 特征")])]),n("li",[n("a",{attrs:{href:"#_2-2-基本概念"}},[s._v("2.2 基本概念")])]),n("li",[n("a",{attrs:{href:"#_2-3-sentinel与hystrix比较"}},[s._v("2.3 Sentinel与Hystrix比较")])])])]),n("li",[n("a",{attrs:{href:"#_3-基本使用-资源与规则"}},[s._v("3. 基本使用 - 资源与规则")]),n("ul",[n("li",[n("a",{attrs:{href:"#_3-1-资源定义【多用方式1、2、4】"}},[s._v("3.1 资源定义【多用方式1、2、4】")])]),n("li",[n("a",{attrs:{href:"#_3-2-定义规则"}},[s._v("3.2 定义规则")])])])]),n("li",[n("a",{attrs:{href:"#_4-其它-api"}},[s._v("4. 其它 API")]),n("ul",[n("li",[n("a",{attrs:{href:"#_4-1-业务异常统计-tracer"}},[s._v("4.1 业务异常统计 Tracer")])]),n("li",[n("a",{attrs:{href:"#_4-2-上下文工具类-contextutil"}},[s._v("4.2 上下文工具类 ContextUtil")])]),n("li",[n("a",{attrs:{href:"#_4-3-指标统计配置"}},[s._v("4.3 指标统计配置")])])])]),n("li",[n("a",{attrs:{href:"#_5-dashboard"}},[s._v("5. Dashboard")])]),n("li",[n("a",{attrs:{href:"#_6-sentinel整合springboot"}},[s._v("6. Sentinel整合SpringBoot")]),n("ul",[n("li",[n("a",{attrs:{href:"#_6-1-开源框架适配"}},[s._v("6.1 开源框架适配")])]),n("li",[n("a",{attrs:{href:"#_6-2-官方示例sentinel整合springboot"}},[s._v("6.2 官方示例Sentinel整合SpringBoot")])]),n("li",[n("a",{attrs:{href:"#_6-3-导入依赖"}},[s._v("6.3 导入依赖")])]),n("li",[n("a",{attrs:{href:"#_6-4-启动sentinel"}},[s._v("6.4 启动sentinel")])]),n("li",[n("a",{attrs:{href:"#_6-5-相关配置"}},[s._v("6.5 相关配置")])]),n("li",[n("a",{attrs:{href:"#_6-6-懒加载-访问的时候才会加载"}},[s._v("6.6 懒加载，访问的时候才会加载")])]),n("li",[n("a",{attrs:{href:"#_6-7-实时监控图标显示"}},[s._v("6.7 实时监控图标显示")])]),n("li",[n("a",{attrs:{href:"#_6-8-流控规则与效果"}},[s._v("6.8 流控规则与效果")])])])]),n("li",[n("a",{attrs:{href:"#_7-熔断降级"}},[s._v("7. 熔断降级")]),n("ul",[n("li",[n("a",{attrs:{href:"#_7-1-使用sentinel来保护feign远程调用-熔断"}},[s._v("7.1 使用sentinel来保护feign远程调用(熔断)")])])])]),n("li",[n("a",{attrs:{href:"#_8-自定义受保护资源"}},[s._v("8. 自定义受保护资源")]),n("ul",[n("li",[n("a",{attrs:{href:"#_8-1-主流框架的默认适配"}},[s._v("8.1 主流框架的默认适配")])]),n("li",[n("a",{attrs:{href:"#_8-2-抛出异常的方式定义资源"}},[s._v("8.2 抛出异常的方式定义资源")])]),n("li",[n("a",{attrs:{href:"#_8-3-注解方式定义资源"}},[s._v("8.3 注解方式定义资源")])]),n("li",[n("a",{attrs:{href:"#_8-4-注意-以上三种方式一定要配置被限流后的默认返回-sentinelconfig"}},[s._v("8.4 注意(以上三种方式一定要配置被限流后的默认返回) SentinelConfig")])])])]),n("li",[n("a",{attrs:{href:"#_9-网关控流"}},[s._v("9. 网关控流")]),n("ul",[n("li",[n("a",{attrs:{href:"#_9-1-为什么要网关控流"}},[s._v("9.1 为什么要网关控流?")])]),n("li",[n("a",{attrs:{href:"#_9-2-为网关服务整合网关流控"}},[s._v("9.2 为网关服务整合网关流控")])])])])])]),n("p"),s._v(" "),n("h3",{attrs:{id:"_1-1-什么是熔断"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-什么是熔断"}},[s._v("#")]),s._v(" 1.1 什么是熔断")]),s._v(" "),n("p",[s._v("A 服务调用 B 服务的某个功能， 由于网络不稳定问题， 或者 B 服务卡机， 导致功能时间超长。 如果这样子的次数太多。 我们就可以直接将 B 断路了（A 不再请求 B 接口） ， 凡是调用 B 的直接返回降级数据， 不必等待 B 的超长执行。 这样 B 的故障问题， 就不会级联影响到 A。")]),s._v(" "),n("h3",{attrs:{id:"_1-2-什么是降级"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-什么是降级"}},[s._v("#")]),s._v(" 1.2 什么是降级")]),s._v(" "),n("p",[s._v("整个网站处于流量高峰期， 服务器压力剧增， 根据当前业务情况及流量， 对一些服务和页面进行有策略的降级[停止服务， 所有的调用直接返回降级数据]。 以此缓解服务器资源的的压力， 以保证核心业务的正常运行， 同时也保持了客户和大部分客户的得到正确的相应。")]),s._v(" "),n("h3",{attrs:{id:"_1-3-异同"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-异同"}},[s._v("#")]),s._v(" 1.3 异同")]),s._v(" "),n("p",[s._v("​\t相同点：")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("为了保证集群大部分服务的可用性和可靠性， 防止崩溃， 牺牲小我")])]),s._v(" "),n("li",[n("p",[s._v("用户最终都是体验到某个功能不可用")]),s._v(" "),n("p",[s._v("不同点：")])]),s._v(" "),n("li",[n("p",[s._v("熔断是被调用方故障， 触发的系统主动规则")])]),s._v(" "),n("li",[n("p",[s._v("降级是基于全局考虑， 停止一些正常服务， 释放资源")])])]),s._v(" "),n("h3",{attrs:{id:"_1-4-什么是限流"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-什么是限流"}},[s._v("#")]),s._v(" 1.4 什么是限流")]),s._v(" "),n("p",[s._v("对打入服务的请求流量进行控制， 使服务能够承担不超过自己能力的流量压力")]),s._v(" "),n("h2",{attrs:{id:"_2-sentinel简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-sentinel简介"}},[s._v("#")]),s._v(" 2. Sentinel简介")]),s._v(" "),n("p",[s._v("官方文档： https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D\n项目地址： https://github.com/alibaba/Sentinel\n随着微服务的流行， 服务和服务之间的稳定性变得越来越重要。 Sentinel 以流量为切入点，从流量控制、 熔断降级、 系统负载保护等多个维度保护服务的稳定性。")]),s._v(" "),n("h3",{attrs:{id:"_2-1-特征"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-特征"}},[s._v("#")]),s._v(" 2.1 特征")]),s._v(" "),n("ul",[n("li",[s._v("丰富的应用场景： Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景， 例如秒杀（即突发流量控制在系统容量可以承受的范围） 、 消息削峰填谷、 集群流量控制、 实时熔断下游不可用应用等。")]),s._v(" "),n("li",[s._v("完备的实时监控： Sentinel 同时提供实时的监控功能。 您可以在控制台中看到接入应用的单台机器秒级数据， 甚至 500 台以下规模的集群的汇总运行情况。")]),s._v(" "),n("li",[s._v("广泛的开源生态： Sentinel 提供开箱即用的与其它开源框架/库的整合模块， 例如与 Spring Cloud、 Dubbo、 gRPC 的整合。 您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。")]),s._v(" "),n("li",[s._v("完善的 SPI 扩展点： Sentinel 提供简单易用、 完善的 SPI 扩展接口。 您可以通过实现扩展接口来快速地定制逻辑。 例如定制规则管理、 适配动态数据源等。\n"),n("img",{staticClass:"lazy",attrs:{alt:"image-20220110164306865","data-src":a(625),loading:"lazy"}})])]),s._v(" "),n("p",[s._v("Sentinel 分为两个部分 :")]),s._v(" "),n("p",[s._v("核心库（Java 客户端） 不依赖任何框架/库， 能够运行于所有 Java 运行时环境， 同时对 Dubbo / Spring Cloud 等框架也有较好的支持。")]),s._v(" "),n("p",[s._v("控制台（ Dashboard） 基于 Spring Boot 开发， 打包后可以直接运行， 不需要额外的Tomcat 等应用容器。")]),s._v(" "),n("h3",{attrs:{id:"_2-2-基本概念"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-基本概念"}},[s._v("#")]),s._v(" 2.2 基本概念")]),s._v(" "),n("h4",{attrs:{id:"_2-2-1-资源"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1-资源"}},[s._v("#")]),s._v(" 2.2.1 资源")]),s._v(" "),n("p",[s._v("资源是 Sentinel 的关键概念。 它可以是 Java 应用程序中的任何内容， 例如， 由应用程序提供的服务， 或由应用程序调用的其它应用提供的服务， 甚至可以是一段代码。 在接下来的文档中， 我们都会用资源来描述代码块。")]),s._v(" "),n("p",[s._v("只要通过 Sentinel API 定义的代码， 就是资源， 能够被 Sentinel 保护起来。 大部分情况下，可以使用方法签名， URL， 甚至服务名称作为资源名来标示资源。")]),s._v(" "),n("h4",{attrs:{id:"_2-2-2-规则"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-规则"}},[s._v("#")]),s._v(" 2.2.2 规则")]),s._v(" "),n("p",[s._v("围绕资源的实时状态设定的规则， 可以包括"),n("strong",[s._v("流量控制规则")]),s._v("、 "),n("strong",[s._v("熔断降级规则")]),s._v("以及"),n("strong",[s._v("系统保护规则")]),s._v("。 所有规则可以动态实时调整。")]),s._v(" "),n("h3",{attrs:{id:"_2-3-sentinel与hystrix比较"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-sentinel与hystrix比较"}},[s._v("#")]),s._v(" 2.3 Sentinel与Hystrix比较")]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220110165114710","data-src":"assets/14.glsc_sentinel/3ef8adc5a66b56e2e9a22cf70aea423e.png",loading:"lazy"}})]),s._v(" "),n("h2",{attrs:{id:"_3-基本使用-资源与规则"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-基本使用-资源与规则"}},[s._v("#")]),s._v(" 3. 基本使用 - 资源与规则")]),s._v(" "),n("p",[s._v("官方文档:https://sentinelguard.io/zh-cn/docs/basic-api-resource-rule.html")]),s._v(" "),n("p",[s._v("我们说的资源，可以是任何东西，服务，服务里的方法，甚至是一段代码。使用 Sentinel 来进行资源保护，主要分为几个步骤:")]),s._v(" "),n("p",[s._v("定义资源\n定义规则\n检验规则是否生效\n先把可能需要保护的资源定义好，之后再配置规则。也可以理解为，只要有了资源，我们就可以在任何时候灵活地定义各种流量控制规则。在编码的时候，只需要考虑这个代码是否需要保护，如果需要保护，就将之定义为一个资源。")]),s._v(" "),n("p",[s._v("对于主流的框架，我们提供适配，只需要按照适配中的说明配置，Sentinel 就会默认定义提供的服务，方法等为资源。")]),s._v(" "),n("h3",{attrs:{id:"_3-1-资源定义【多用方式1、2、4】"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-资源定义【多用方式1、2、4】"}},[s._v("#")]),s._v(" 3.1 资源定义【多用方式1、2、4】")]),s._v(" "),n("h4",{attrs:{id:"方式一-主流框架的默认适配"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#方式一-主流框架的默认适配"}},[s._v("#")]),s._v(" 方式一：主流框架的默认适配")]),s._v(" "),n("p",[s._v("为了减少开发的复杂程度，我们对大部分的主流框架，例如 Web Servlet、Dubbo、Spring Cloud、gRPC、Spring WebFlux、Reactor 等都做了适配。您只需要引入对应的依赖即可方便地整合 Sentinel。可以参见：")]),s._v(" "),n("p",[n("a",{attrs:{href:"https://sentinelguard.io/zh-cn/docs/open-source-framework-integrations.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("主流框架的文档"),n("OutboundLink")],1)]),s._v(" "),n("h4",{attrs:{id:"方式二-抛出异常的方式定义资源"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#方式二-抛出异常的方式定义资源"}},[s._v("#")]),s._v(" 方式二：抛出异常的方式定义资源")]),s._v(" "),n("p",[n("code",[s._v("SphU")]),s._v(" 包含了 try-catch 风格的 API。用这种方式，当资源发生了限流之后会抛出 "),n("code",[s._v("BlockException")]),s._v("。这个时候可以捕捉异常，进行限流之后的逻辑处理。示例代码如下:")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1.5.0 版本开始可以利用 try-with-resources 特性")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 资源名可使用任意有业务语义的字符串，比如方法名、接口名或其它可唯一标识的字符串。")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),s._v(" entry "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SphU")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("entry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resourceName"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 被保护的业务逻辑")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// do something here...")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BlockException")]),s._v(" ex"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 资源访问阻止，被限流或被降级")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 在此处进行相应的处理操作")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("特别地，若 entry 的时候传入了热点参数，那么 exit 的时候也一定要带上对应的参数（exit(count, args)），否则可能会有统计错误。这个时候不能使用 try-with-resources 的方式。另外通过 Tracer.trace(ex) 来统计异常信息时，由于 try-with-resources 语法中 catch 调用顺序的问题，会导致无法正确统计异常数，因此统计异常信息时也不能在 try-with-resources 的 catch 块中调用 Tracer.trace(ex)。\n1.5.0 之前的版本的示例：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),s._v(" entry "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 务必保证finally会被执行")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 资源名可使用任意有业务语义的字符串")]),s._v("\n  entry "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SphU")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("entry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"自定义资源名"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 被保护的业务逻辑")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// do something...")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BlockException")]),s._v(" e1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 资源访问阻止，被限流或被降级")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 进行相应的处理操作")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("finally")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("entry "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    entry"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("exit")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("p",[n("strong",[s._v("注意")]),s._v("： SphU.entry(xxx) 需要与 entry.exit() 方法成对出现，匹配调用，否则会导致调用链记录异常，抛出 ErrorEntryFreeException 异常。")]),s._v(" "),n("h4",{attrs:{id:"方式三-返回布尔值方式定义资源"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#方式三-返回布尔值方式定义资源"}},[s._v("#")]),s._v(" 方式三：返回布尔值方式定义资源")]),s._v(" "),n("p",[s._v("SphO 提供 if-else 风格的 API。用这种方式，当资源发生了限流之后会返回 false，这个时候可以根据返回值，进行限流之后的逻辑处理。示例代码如下:")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[s._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 资源名可使用任意有业务语义的字符串")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SphO")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("entry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"自定义资源名"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 务必保证finally会被执行")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n      * 被保护的业务逻辑\n      */")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("finally")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SphO")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("exit")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 资源访问阻止，被限流或被降级")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 进行相应的处理操作")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("h4",{attrs:{id:"方式四-注解方式定义资源"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#方式四-注解方式定义资源"}},[s._v("#")]),s._v(" 方式四：注解方式定义资源")]),s._v(" "),n("p",[s._v("Sentinel 支持通过 "),n("code",[s._v("@SentinelResource")]),s._v(" 注解定义资源并配置 "),n("code",[s._v("blockHandler")]),s._v(" 和 "),n("code",[s._v("fallback")]),s._v(" 函数来进行限流之后的处理。示例：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 原本的业务方法.")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@SentinelResource")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("blockHandler "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"blockHandlerForGetUser"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("User")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getUserById")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RuntimeException")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"getUserById command failed"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// blockHandler 函数，原方法调用被限流/降级/系统保护的时候调用")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("User")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("blockHandlerForGetUser")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BlockException")]),s._v(" ex"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("User")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("注意 "),n("code",[s._v("blockHandler")]),s._v(" 函数会在原方法被限流/降级/系统保护的时候调用，而 "),n("code",[s._v("fallback")]),s._v(" 函数会针对所有类型的异常。请注意 "),n("code",[s._v("blockHandler")]),s._v(" 和 "),n("code",[s._v("fallback")]),s._v(" 函数的形式要求，更多指引可以参见 "),n("a",{attrs:{href:"https://sentinelguard.io/zh-cn/docs/annotation-support.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Sentinel 注解支持文档"),n("OutboundLink")],1),s._v("。")]),s._v(" "),n("h4",{attrs:{id:"方式五-异步调用支持"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#方式五-异步调用支持"}},[s._v("#")]),s._v(" 方式五：异步调用支持")]),s._v(" "),n("p",[s._v("Sentinel 支持异步调用链路的统计。在异步调用中，需要通过 "),n("code",[s._v("SphU.asyncEntry(xxx)")]),s._v(" 方法定义资源，并通常需要在异步的回调函数中调用 "),n("code",[s._v("exit")]),s._v(" 方法。以下是一个简单的示例：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AsyncEntry")]),s._v(" entry "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SphU")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("asyncEntry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("resourceName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 异步调用.")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("doAsync")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("userId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" result "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 在此处处理异步调用的结果.")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("finally")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 在回调结束后 exit.")]),s._v("\n            entry"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("exit")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BlockException")]),s._v(" ex"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Request blocked.")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Handle the exception (e.g. retry or fallback).")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("p",[n("code",[s._v("SphU.asyncEntry(xxx)")]),s._v(" 不会影响当前（调用线程）的 Context，因此以下两个 entry 在调用链上是平级关系（处于同一层），而不是嵌套关系：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 调用链类似于：")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// -parent")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ---asyncResource")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ---syncResource")]),s._v("\nasyncEntry "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SphU")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("asyncEntry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("asyncResource"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nentry "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SphU")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("entry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("normalResource"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("若在异步回调中需要嵌套其它的资源调用（无论是 entry 还是 asyncEntry），只需要借助 Sentinel 提供的上下文切换功能，在对应的地方通过 ContextUtil.runOnContext(context, f) 进行 Context 变换，将对应资源调用处的 Context 切换为生成的异步 Context，即可维持正确的调用链路关系。示例如下：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("handleResult")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),s._v(" entry "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        entry "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SphU")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("entry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"handleResultForAsync"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Handle your result here.")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BlockException")]),s._v(" ex"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Blocked for the result handler.")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("finally")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("entry "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            entry"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("exit")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("someAsync")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AsyncEntry")]),s._v(" entry "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SphU")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("asyncEntry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("resourceName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Asynchronous invocation.")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("doAsync")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("userId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" result "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 在异步回调中进行上下文变换，通过 AsyncEntry 的 getAsyncContext 方法获取异步 Context")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ContextUtil")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("runOnContext")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("entry"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getAsyncContext")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 此处嵌套正常的资源调用.")]),s._v("\n                    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("handleResult")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("finally")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                    entry"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("exit")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BlockException")]),s._v(" ex"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Request blocked.")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Handle the exception (e.g. retry or fallback).")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br")])]),n("p",[s._v("此时的调用链就类似于：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("parent\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("asyncInvocation\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("handleResultForAsync\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("更详细的示例可以参考 Demo 中的 "),n("a",{attrs:{href:"https://github.com/alibaba/Sentinel/blob/master/sentinel-demo/sentinel-demo-basic/src/main/java/com/alibaba/csp/sentinel/demo/AsyncEntryDemo.java",target:"_blank",rel:"noopener noreferrer"}},[s._v("AsyncEntryDemo"),n("OutboundLink")],1),s._v("，里面包含了普通资源与异步资源之间的各种嵌套示例。")]),s._v(" "),n("h3",{attrs:{id:"_3-2-定义规则"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-定义规则"}},[s._v("#")]),s._v(" 3.2 定义规则")]),s._v(" "),n("h4",{attrs:{id:"_3-2-1-规则的种类"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-规则的种类"}},[s._v("#")]),s._v(" 3.2.1 规则的种类")]),s._v(" "),n("p",[s._v("Sentinel 的所有规则都可以在内存态中动态地查询及修改，修改之后立即生效。同时 Sentinel 也提供相关 API，供您来定制自己的规则策略。")]),s._v(" "),n("p",[s._v("Sentinel 支持以下几种规则：流量控制规则、熔断降级规则、系统保护规则、来源访问控制规则 和 热点参数规则。")]),s._v(" "),n("h5",{attrs:{id:"_3-2-1-1-流量控制规则-flowrule"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-1-流量控制规则-flowrule"}},[s._v("#")]),s._v(" 3.2.1.1 流量控制规则 (FlowRule)")]),s._v(" "),n("p",[s._v("流量规则的定义\n重要属性：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("Field")]),s._v(" "),n("th",[s._v("说明")]),s._v(" "),n("th",[s._v("默认值")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("resource")]),s._v(" "),n("td",[s._v("资源名，资源名是限流规则的作用对象")]),s._v(" "),n("td")]),s._v(" "),n("tr",[n("td",[s._v("count")]),s._v(" "),n("td",[s._v("限流阈值")]),s._v(" "),n("td")]),s._v(" "),n("tr",[n("td",[s._v("grade")]),s._v(" "),n("td",[s._v("限流阈值类型，QPS 或线程数模式")]),s._v(" "),n("td",[s._v("QPS 模式")])]),s._v(" "),n("tr",[n("td",[s._v("limitApp")]),s._v(" "),n("td",[s._v("流控针对的调用来源")]),s._v(" "),n("td",[n("code",[s._v("default")]),s._v("，代表不区分调用来源")])]),s._v(" "),n("tr",[n("td",[s._v("strategy")]),s._v(" "),n("td",[s._v("调用关系限流策略：直接、链路、关联")]),s._v(" "),n("td",[s._v("根据资源本身（直接）")])]),s._v(" "),n("tr",[n("td",[s._v("controlBehavior")]),s._v(" "),n("td",[s._v("流控效果（直接拒绝 / 排队等待 / 慢启动模式），不支持按调用关系限流")]),s._v(" "),n("td",[s._v("直接拒绝")])])])]),s._v(" "),n("p",[s._v("同一个资源可以同时有多个限流规则。")]),s._v(" "),n("p",[n("strong",[s._v("通过代码定义流量控制规则")])]),s._v(" "),n("p",[s._v("理解上面规则的定义之后，我们可以通过调用 "),n("code",[s._v("FlowRuleManager.loadRules()")]),s._v(" 方法来用硬编码的方式定义流量控制规则，比如：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("initFlowQpsRule")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("List")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FlowRule")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" rules "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ArrayList")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FlowRule")]),s._v(" rule1 "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FlowRule")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    rule1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setResource")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("resource"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Set max qps to 20")]),s._v("\n    rule1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setCount")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    rule1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setGrade")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RuleConstant")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("FLOW_GRADE_QPS"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    rule1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setLimitApp")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    rules"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rule1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FlowRuleManager")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("loadRules")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rules"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("更多详细内容可以参考 "),n("a",{attrs:{href:"https://sentinelguard.io/zh-cn/docs/flow-control.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("流量控制"),n("OutboundLink")],1),s._v("。")]),s._v(" "),n("h5",{attrs:{id:"_3-2-1-2-熔断降级规则-degraderule"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-2-熔断降级规则-degraderule"}},[s._v("#")]),s._v(" 3.2.1.2 熔断降级规则 (DegradeRule)")]),s._v(" "),n("p",[s._v("熔断降级规则包含下面几个重要的属性：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("Field")]),s._v(" "),n("th",[s._v("说明")]),s._v(" "),n("th",[s._v("默认值")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("resource")]),s._v(" "),n("td",[s._v("资源名，即规则的作用对象")]),s._v(" "),n("td")]),s._v(" "),n("tr",[n("td",[s._v("grade")]),s._v(" "),n("td",[s._v("熔断策略，支持慢调用比例/异常比例/异常数策略")]),s._v(" "),n("td",[s._v("慢调用比例")])]),s._v(" "),n("tr",[n("td",[s._v("count")]),s._v(" "),n("td",[s._v("慢调用比例模式下为慢调用临界 RT（超出该值计为慢调用）；异常比例/异常数模式下为对应的阈值")]),s._v(" "),n("td")]),s._v(" "),n("tr",[n("td",[s._v("timeWindow")]),s._v(" "),n("td",[s._v("熔断时长，单位为 s")]),s._v(" "),n("td")]),s._v(" "),n("tr",[n("td",[s._v("minRequestAmount")]),s._v(" "),n("td",[s._v("熔断触发的最小请求数，请求数小于该值时即使异常比率超出阈值也不会熔断（1.7.0 引入）")]),s._v(" "),n("td",[s._v("5")])]),s._v(" "),n("tr",[n("td",[s._v("statIntervalMs")]),s._v(" "),n("td",[s._v("统计时长（单位为 ms），如 60*1000 代表分钟级（1.8.0 引入）")]),s._v(" "),n("td",[s._v("1000 ms")])]),s._v(" "),n("tr",[n("td",[s._v("slowRatioThreshold")]),s._v(" "),n("td",[s._v("慢调用比例阈值，仅慢调用比例模式有效（1.8.0 引入）")]),s._v(" "),n("td")])])]),s._v(" "),n("p",[s._v("同一个资源可以同时有多个降级规则。")]),s._v(" "),n("p",[s._v("理解上面规则的定义之后，我们可以通过调用 "),n("code",[s._v("DegradeRuleManager.loadRules()")]),s._v(" 方法来用硬编码的方式定义流量控制规则。")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("initDegradeRule")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("List")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DegradeRule")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" rules "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ArrayList")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DegradeRule")]),s._v(" rule "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DegradeRule")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("resource"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setGrade")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CircuitBreakerStrategy")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ERROR_RATIO"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getType")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setCount")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.7")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Threshold is 70% error ratio")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setMinRequestAmount")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setStatIntervalMs")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 30s")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setTimeWindow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    rules"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rule"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DegradeRuleManager")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("loadRules")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rules"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("更多详情可以参考 "),n("a",{attrs:{href:"https://sentinelguard.io/zh-cn/docs/circuit-breaking.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("熔断降级"),n("OutboundLink")],1),s._v("。")]),s._v(" "),n("h5",{attrs:{id:"_3-2-1-3-系统保护规则-systemrule"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-3-系统保护规则-systemrule"}},[s._v("#")]),s._v(" 3.2.1.3 系统保护规则 (SystemRule)")]),s._v(" "),n("p",[s._v("Sentinel 系统自适应限流从整体维度对应用入口流量进行控制，结合应用的 Load、CPU 使用率、总体平均 RT、入口 QPS 和并发线程数等几个维度的监控指标，通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。")]),s._v(" "),n("p",[s._v("系统规则包含下面几个重要的属性：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("Field")]),s._v(" "),n("th",[s._v("说明")]),s._v(" "),n("th",[s._v("默认值")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("highestSystemLoad")]),s._v(" "),n("td",[n("code",[s._v("load1")]),s._v(" 触发值，用于触发自适应控制阶段")]),s._v(" "),n("td",[s._v("-1 (不生效)")])]),s._v(" "),n("tr",[n("td",[s._v("avgRt")]),s._v(" "),n("td",[s._v("所有入口流量的平均响应时间")]),s._v(" "),n("td",[s._v("-1 (不生效)")])]),s._v(" "),n("tr",[n("td",[s._v("maxThread")]),s._v(" "),n("td",[s._v("入口流量的最大并发数")]),s._v(" "),n("td",[s._v("-1 (不生效)")])]),s._v(" "),n("tr",[n("td",[s._v("qps")]),s._v(" "),n("td",[s._v("所有入口资源的 QPS")]),s._v(" "),n("td",[s._v("-1 (不生效)")])]),s._v(" "),n("tr",[n("td",[s._v("highestCpuUsage")]),s._v(" "),n("td",[s._v("当前系统的 CPU 使用率（0.0-1.0）")]),s._v(" "),n("td",[s._v("-1 (不生效)")])])])]),s._v(" "),n("p",[s._v("理解上面规则的定义之后，我们可以通过调用 "),n("code",[s._v("SystemRuleManager.loadRules()")]),s._v(" 方法来用硬编码的方式定义流量控制规则：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("initSystemProtectionRule")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("List")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SystemRule")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" rules "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ArrayList")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SystemRule")]),s._v(" rule "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SystemRule")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  rule"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setHighestSystemLoad")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  rules"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rule"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SystemRuleManager")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("loadRules")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rules"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("更多详情可以参考 "),n("a",{attrs:{href:"https://sentinelguard.io/zh-cn/docs/system-adaptive-protection.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("系统自适应保护"),n("OutboundLink")],1),s._v("。")]),s._v(" "),n("h5",{attrs:{id:"_3-2-1-4-访问控制规则-authorityrule"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-4-访问控制规则-authorityrule"}},[s._v("#")]),s._v(" 3.2.1.4 访问控制规则 (AuthorityRule)")]),s._v(" "),n("p",[s._v("很多时候，我们需要根据调用方来限制资源是否通过，这时候可以使用 Sentinel 的访问控制（黑白名单）的功能。黑白名单根据资源的请求来源（origin）限制资源是否通过，若配置白名单则只有请求来源位于白名单内时才可通过；若配置黑名单则请求来源位于黑名单时不通过，其余的请求通过。")]),s._v(" "),n("p",[s._v("授权规则，即黑白名单规则（AuthorityRule）非常简单，主要有以下配置项：\n授权规则，即黑白名单规则（AuthorityRule）非常简单，主要有以下配置项：")]),s._v(" "),n("ul",[n("li",[s._v("resource：资源名，即限流规则的作用对象")]),s._v(" "),n("li",[s._v("limitApp：对应的黑名单/白名单，不同 origin 用 , 分隔，如 appA,appB")]),s._v(" "),n("li",[s._v("strategy：限制模式，AUTHORITY_WHITE 为白名单模式，AUTHORITY_BLACK 为黑名单模式，默认为白名单模式")])]),s._v(" "),n("p",[s._v("更多详情可以参考 "),n("a",{attrs:{href:"https://sentinelguard.io/zh-cn/docs/origin-authority-control.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("来源访问控制"),n("OutboundLink")],1),s._v("。")]),s._v(" "),n("h5",{attrs:{id:"_3-2-1-5-热点规则-paramflowrule"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-5-热点规则-paramflowrule"}},[s._v("#")]),s._v(" 3.2.1.5 热点规则 (ParamFlowRule)")]),s._v(" "),n("p",[s._v("详情可以参考 "),n("a",{attrs:{href:"https://sentinelguard.io/zh-cn/docs/parameter-flow-control.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("热点参数限流"),n("OutboundLink")],1),s._v("。")]),s._v(" "),n("h4",{attrs:{id:"_3-2-2-查询更改规则"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-2-查询更改规则"}},[s._v("#")]),s._v(" 3.2.2 查询更改规则")]),s._v(" "),n("p",[s._v("引入了 transport 模块后，可以通过以下的 HTTP API 来获取所有已加载的规则：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[s._v("http"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("localhost"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8719")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("getRules"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),s._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("XXXX"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("其中，"),n("code",[s._v("type=flow")]),s._v(" 以 JSON 格式返回现有的限流规则，degrade 返回现有生效的降级规则列表，system 则返回系统保护规则。")]),s._v(" "),n("p",[s._v("获取所有热点规则：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[s._v("http"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("localhost"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8719")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("getParamRules\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("其中，type 可以输入 "),n("code",[s._v("flow")]),s._v("、"),n("code",[s._v("degrade")]),s._v(" 等方式来制定更改的规则种类，"),n("code",[s._v("data")]),s._v(" 则是对应的 JSON 格式的规则。")]),s._v(" "),n("h4",{attrs:{id:"_3-2-3-定制自己的持久化规则"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-3-定制自己的持久化规则"}},[s._v("#")]),s._v(" 3.2.3 定制自己的持久化规则")]),s._v(" "),n("p",[s._v("上面的规则配置，都是存在内存中的。即如果应用重启，这个规则就会失效。因此我们提供了开放的接口，您可以通过实现 DataSource 接口的方式，来自定义规则的存储数据源。通常我们的建议有：")]),s._v(" "),n("ul",[n("li",[s._v("整合动态配置系统，如 ZooKeeper、Nacos 等，动态地实时刷新配置规则")]),s._v(" "),n("li",[s._v("结合 RDBMS、NoSQL、VCS 等来实现该规则")]),s._v(" "),n("li",[s._v("配合 Sentinel Dashboard 使用\n更多详情请参考 "),n("a",{attrs:{href:"https://sentinelguard.io/zh-cn/docs/dynamic-rule-configuration.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("动态规则配置"),n("OutboundLink")],1),s._v("。")])]),s._v(" "),n("h4",{attrs:{id:"_3-2-4-规则生效的效果"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-4-规则生效的效果"}},[s._v("#")]),s._v(" 3.2.4 规则生效的效果")]),s._v(" "),n("h5",{attrs:{id:"_3-2-4-1-判断限流降级异常"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-4-1-判断限流降级异常"}},[s._v("#")]),s._v(" 3.2.4.1 判断限流降级异常")]),s._v(" "),n("p",[s._v("通过以下方法判断是否为 Sentinel 的流控降级异常：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BlockException")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("isBlockException")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Throwable")]),s._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("除了在业务代码逻辑上看到规则生效，我们也可以通过下面简单的方法，来校验规则生效的效果：")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("暴露的 HTTP 接口")]),s._v("：通过运行下面命令 curl http://localhost:8719/cnode?id=<资源名称>，观察返回的数据。如果规则生效，在返回的数据栏中的 block 以及 block(m) 中会有显示")]),s._v(" "),n("li",[n("strong",[s._v("日志")]),s._v("：Sentinel 提供秒级的资源运行日志以及限流日志，详情可以参考 "),n("a",{attrs:{href:"https://sentinelguard.io/zh-cn/docs/logs.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("日志文档"),n("OutboundLink")],1)])]),s._v(" "),n("h5",{attrs:{id:"_3-2-4-2-block-事件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-4-2-block-事件"}},[s._v("#")]),s._v(" 3.2.4.2 block 事件")]),s._v(" "),n("p",[s._v("Sentinel 提供以下扩展接口，可以通过 StatisticSlotCallbackRegistry 向 StatisticSlot 注册回调函数：")]),s._v(" "),n("ul",[n("li",[s._v("ProcessorSlotEntryCallback: callback when resource entry passed (onPass) or blocked (onBlocked)")]),s._v(" "),n("li",[s._v("ProcessorSlotExitCallback: callback when resource entry successfully completed (onExit)\n可以利用这些回调接口来实现报警等功能，实时的监控信息可以从 ClusterNode 中实时获取。")])]),s._v(" "),n("h2",{attrs:{id:"_4-其它-api"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-其它-api"}},[s._v("#")]),s._v(" 4. 其它 API")]),s._v(" "),n("h3",{attrs:{id:"_4-1-业务异常统计-tracer"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-业务异常统计-tracer"}},[s._v("#")]),s._v(" 4.1 业务异常统计 Tracer")]),s._v(" "),n("p",[s._v("业务异常记录类 Tracer 用于记录业务异常。相关方法：")]),s._v(" "),n("ul",[n("li",[s._v("trace(Throwable e)：记录业务异常（非 BlockException 异常），对应的资源为当前线程 context 下 entry 对应的资源。")]),s._v(" "),n("li",[s._v("trace(Throwable e, int count)：记录业务异常（非 BlockException 异常），异常数目为传入的 count。")]),s._v(" "),n("li",[s._v("traceEntry(Throwable, int, Entry)：向传入 entry 对应的资源记录业务异常（非 BlockException 异常），异常数目为传入的 count。\n如果用户通过 SphU 或 SphO 手动定义资源，则 Sentinel 不能感知上层业务的异常，需要手动调用 Tracer.trace(ex) 来记录业务异常，否则对应的异常不会统计到 Sentinel 异常计数中。注意不要在 try-with-resources 形式的 SphU.entry(xxx) 中使用，否则会统计不上。")])]),s._v(" "),n("p",[s._v("从 1.3.1 版本开始，注解方式定义资源支持自动统计业务异常，无需手动调用 Tracer.trace(ex) 来记录业务异常。Sentinel 1.3.1 以前的版本需要手动记录。")]),s._v(" "),n("h3",{attrs:{id:"_4-2-上下文工具类-contextutil"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-上下文工具类-contextutil"}},[s._v("#")]),s._v(" 4.2 上下文工具类 ContextUtil")]),s._v(" "),n("p",[s._v("相关静态方法：")]),s._v(" "),n("p",[n("strong",[s._v("标识进入调用链入口（上下文）：")])]),s._v(" "),n("p",[s._v("以下静态方法用于标识调用链路入口，用于区分不同的调用链路：")]),s._v(" "),n("ul",[n("li",[s._v("public static Context enter(String contextName)")]),s._v(" "),n("li",[s._v("public static Context enter(String contextName, String origin)")])]),s._v(" "),n("p",[s._v("其中 "),n("code",[s._v("contextName")]),s._v(" 代表调用链路入口名称（上下文名称），"),n("code",[s._v("origin")]),s._v(" 代表调用来源名称。默认调用来源为空。返回值类型为 "),n("code",[s._v("Context")]),s._v("，即生成的调用链路上下文对象。")]),s._v(" "),n("p",[n("strong",[s._v("注意")]),s._v("："),n("code",[s._v("ContextUtil.enter(xxx)")]),s._v("方法仅在调用链路入口处生效，即仅在当前线程的初次调用生效，后面再调用不会覆盖当前线程的调用链路，直到 exit。"),n("code",[s._v("Context")]),s._v(" 存于 ThreadLocal 中，因此切换线程时可能会丢掉，如果需要跨线程使用可以结合 "),n("code",[s._v("runOnContext")]),s._v(" 方法使用。")]),s._v(" "),n("p",[s._v("流控规则中若选择“流控方式”为“链路”方式，则入口资源名即为上面的 "),n("code",[s._v("contextName")]),s._v("。")]),s._v(" "),n("p",[n("strong",[s._v("退出调用链（清空上下文）：")])]),s._v(" "),n("ul",[n("li",[n("code",[s._v("public static void exit()")]),s._v("：该方法用于退出调用链，清理当前线程的上下文。")])]),s._v(" "),n("p",[n("strong",[s._v("获取当前线程的调用链上下文：")])]),s._v(" "),n("ul",[n("li",[n("code",[s._v("public static Context getContext()")]),s._v("：获取当前线程的调用链路上下文对象。")])]),s._v(" "),n("p",[n("strong",[s._v("在某个调用链上下文中执行代码：")])]),s._v(" "),n("ul",[n("li",[n("code",[s._v("public static void runOnContext(Context context, Runnable f)")]),s._v("：常用于异步调用链路中 context 的变换。")])]),s._v(" "),n("h3",{attrs:{id:"_4-3-指标统计配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-指标统计配置"}},[s._v("#")]),s._v(" 4.3 指标统计配置")]),s._v(" "),n("p",[s._v("Sentinel 底层采用高性能的滑动窗口数据结构来统计实时的秒级指标数据，并支持对滑动窗口进行配置。主要有以下两个配置：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("windowIntervalMs")]),s._v("：滑动窗口的总的时间长度，默认为 1000 ms")]),s._v(" "),n("li",[n("code",[s._v("sampleCount")]),s._v("：滑动窗口划分的格子数目，默认为 2；格子越多则精度越高，但是内存占用也会越多")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"sliding-window-leap-array","data-src":a(626),loading:"lazy"}})]),s._v(" "),n("p",[s._v("我们可以通过 "),n("code",[s._v("SampleCountProperty")]),s._v(" 来动态地变更滑动窗口的格子数目，通过 "),n("code",[s._v("IntervalProperty")]),s._v(" 来动态地变更滑动窗口的总时间长度。注意这两个配置都是"),n("strong",[s._v("全局生效")]),s._v("的，会影响所有资源的所有指标统计。")]),s._v(" "),n("h2",{attrs:{id:"_5-dashboard"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-dashboard"}},[s._v("#")]),s._v(" 5. Dashboard")]),s._v(" "),n("p",[s._v("详情请参考："),n("a",{attrs:{href:"https://sentinelguard.io/zh-cn/docs/dashboard.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Sentinel Dashboard 文档"),n("OutboundLink")],1),s._v("。")]),s._v(" "),n("h2",{attrs:{id:"_6-sentinel整合springboot"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-sentinel整合springboot"}},[s._v("#")]),s._v(" 6. Sentinel整合SpringBoot")]),s._v(" "),n("h3",{attrs:{id:"_6-1-开源框架适配"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-开源框架适配"}},[s._v("#")]),s._v(" 6.1 开源框架适配")]),s._v(" "),n("p",[s._v("https://sentinelguard.io/zh-cn/docs/open-source-framework-integrations.html")]),s._v(" "),n("h3",{attrs:{id:"_6-2-官方示例sentinel整合springboot"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-官方示例sentinel整合springboot"}},[s._v("#")]),s._v(" 6.2 官方示例Sentinel整合SpringBoot")]),s._v(" "),n("p",[s._v("https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel")]),s._v(" "),n("h3",{attrs:{id:"_6-3-导入依赖"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-导入依赖"}},[s._v("#")]),s._v(" 6.3 导入依赖")]),s._v(" "),n("blockquote",[n("p",[s._v("所有服务都需要被监控,所以在common导入sentinel")]),s._v(" "),n("p",[s._v("gulimall-common/pom.xml")])]),s._v(" "),n("div",{staticClass:"language-pom line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("        <dependency>\n            <groupId>com.alibaba.cloud</groupId>\n            <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>\n        </dependency>\t\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("blockquote",[n("p",[s._v("查看导入sentinel-core版本,下载对应版本的jar包")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220110174000667","data-src":a(627),loading:"lazy"}})]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220110174644123","data-src":a(628),loading:"lazy"}})]),s._v(" "),n("h3",{attrs:{id:"_6-4-启动sentinel"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-启动sentinel"}},[s._v("#")]),s._v(" 6.4 启动sentinel")]),s._v(" "),n("p",[s._v("sentinel默认占用8080端口,启动时换个端口")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("java -jar sentinel-dashboard-1.6.3.jar --server.port"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8333")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("blockquote",[n("p",[s._v("访问localhost:8333")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220110175205657","data-src":a(629),loading:"lazy"}})]),s._v(" "),n("blockquote",[n("p",[s._v("默认账号密码都是:sentinel")])]),s._v(" "),n("blockquote",[n("p",[s._v("登录成功后")]),s._v(" "),n("p",[s._v("懒加载，访问的时候才会加载")]),s._v(" "),n("p",[s._v("在Dashboard中的配置是保存在内存中，重启后失效")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220110175238800","data-src":a(630),loading:"lazy"}})]),s._v(" "),n("h3",{attrs:{id:"_6-5-相关配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-5-相关配置"}},[s._v("#")]),s._v(" 6.5 相关配置")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spring")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cloud")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("sentinel")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("transport")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#控制台地址")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dashboard")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" localhost"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8333")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#端口")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8791")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("h3",{attrs:{id:"_6-6-懒加载-访问的时候才会加载"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-6-懒加载-访问的时候才会加载"}},[s._v("#")]),s._v(" 6.6 懒加载，访问的时候才会加载")]),s._v(" "),n("p",[s._v("跑一边业务流程")]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111093818436","data-src":a(631),loading:"lazy"}})]),s._v(" "),n("h3",{attrs:{id:"_6-7-实时监控图标显示"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-7-实时监控图标显示"}},[s._v("#")]),s._v(" 6.7 实时监控图标显示")]),s._v(" "),n("blockquote",[n("p",[s._v("未配置时,事实监控没有数据")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111094030661","data-src":a(632),loading:"lazy"}})]),s._v(" "),n("h4",{attrs:{id:"_6-7-1-为需要监控的服务导入依赖"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-7-1-为需要监控的服务导入依赖"}},[s._v("#")]),s._v(" 6.7.1 为需要监控的服务导入依赖")]),s._v(" "),n("div",{staticClass:"language-pom line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\t\t\x3c!--springboot 收集健康状况信息，提供给sentinel使用--\x3e\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-actuator</artifactId>\n        </dependency>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h4",{attrs:{id:"_6-7-2-配置事实监控"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-7-2-配置事实监控"}},[s._v("#")]),s._v(" 6.7.2 配置事实监控")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("management")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("endpoints")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("web")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("exposure")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("include")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'*'")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h4",{attrs:{id:"_6-7-3-配置相关流控规则"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-7-3-配置相关流控规则"}},[s._v("#")]),s._v(" 6.7.3 配置相关流控规则")]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111101654654","data-src":a(633),loading:"lazy"}})]),s._v(" "),n("blockquote",[n("p",[s._v("访问被流控的资源")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111101509279","data-src":a(634),loading:"lazy"}})]),s._v(" "),n("h3",{attrs:{id:"_6-8-流控规则与效果"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-8-流控规则与效果"}},[s._v("#")]),s._v(" 6.8 流控规则与效果")]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111102329391","data-src":a(635),loading:"lazy"}})]),s._v(" "),n("h4",{attrs:{id:"_6-8-1-流控模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-8-1-流控模式"}},[s._v("#")]),s._v(" 6.8.1 流控模式")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("、直接\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("、关联\n\t"),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("A")]),s._v("限流，"),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("A")]),s._v("关联"),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("B")]),s._v("，如果"),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("B")]),s._v("的流量大就对"),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("A")]),s._v("限流，否则不限\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("、链路\n\t入口限流，只有从这个入口开始的请求，才会被限制\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h4",{attrs:{id:"_6-8-2-流控效果"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-8-2-流控效果"}},[s._v("#")]),s._v(" 6.8.2 流控效果")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("、快速失败\n\t直接拒绝抛出异常\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("、"),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Warm")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Up")]),s._v("\n\t预热启动，例如给定"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("S，"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("S内才将请求增加到阈值"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),s._v("，不会一次性放行"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),s._v("个\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("、排队等待\n\t如果限制阈值"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),s._v("，此时来了"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("700")]),s._v("个请求，"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),s._v("个直接放行，剩下"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v("排队【可以设置超时时间，"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("S内得不到处理也是失败】\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("blockquote",[n("p",[s._v("快速失败的效果")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111102451838","data-src":a(636),loading:"lazy"}})]),s._v(" "),n("h4",{attrs:{id:"_6-8-3-自定义流控响应"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-8-3-自定义流控响应"}},[s._v("#")]),s._v(" 6.8.3 自定义流控响应")]),s._v(" "),n("blockquote",[n("p",[s._v("gulimall-seckill/src/main/java/site/zhourui/gulimall/seckill/config/SeckillSentinelConfig.java")])]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("site"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("zhourui"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gulimall"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("seckill"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("config")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("csp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sentinel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("adapter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("servlet"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("callback"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UrlBlockHandler")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("csp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sentinel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("adapter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("servlet"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("callback"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("WebCallbackManager")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("csp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sentinel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("slots"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("block"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BlockException")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("JSON"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("annotation"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Configuration")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("site"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("zhourui"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("common"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("exception"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BizCodeEnume")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("site"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("zhourui"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("common"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("utils"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("R")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("javax"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("servlet"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("http"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HttpServletRequest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("javax"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("servlet"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("http"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HttpServletResponse")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("io"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IOException")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n * @author zr\n * @date 2022/1/11 10:40\n */")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Configuration")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SeckillSentinelConfig")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SeckillSentinelConfig")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("WebCallbackManager")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setUrlBlockHandler")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UrlBlockHandler")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("blocked")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HttpServletRequest")]),s._v(" httpServletRequest"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HttpServletResponse")]),s._v(" httpServletResponse"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BlockException")]),s._v(" e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IOException")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("R")]),s._v(" error "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("R")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BizCodeEnume")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("TO_MANY_REQUEST"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getCode")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BizCodeEnume")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("TO_MANY_REQUEST"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getMsg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                httpServletResponse"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setCharacterEncoding")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"UTF-8"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//解决中文乱码")]),s._v("\n                httpServletResponse"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setContentType")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"application/json"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                httpServletResponse"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getWriter")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("JSON"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("toJSONString")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br")])]),n("blockquote",[n("p",[s._v("测试效果")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111105438169","data-src":a(637),loading:"lazy"}})]),s._v(" "),n("h2",{attrs:{id:"_7-熔断降级"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-熔断降级"}},[s._v("#")]),s._v(" 7. 熔断降级")]),s._v(" "),n("h3",{attrs:{id:"_7-1-使用sentinel来保护feign远程调用-熔断"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-使用sentinel来保护feign远程调用-熔断"}},[s._v("#")]),s._v(" 7.1 使用sentinel来保护feign远程调用(熔断)")]),s._v(" "),n("h4",{attrs:{id:"_7-1-1-在服务的调用方指定降级策略"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-1-在服务的调用方指定降级策略"}},[s._v("#")]),s._v(" 7.1.1 在服务的调用方指定降级策略")]),s._v(" "),n("h5",{attrs:{id:"_7-1-1-1-开启调用方的熔断保护"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-1-1-开启调用方的熔断保护"}},[s._v("#")]),s._v(" 7.1.1.1 开启调用方的熔断保护")]),s._v(" "),n("p",[n("strong",[s._v("场景：gulimall-product服务调用gulimall-seckill服务")])]),s._v(" "),n("blockquote",[n("p",[s._v("开启sentinel监控并熔断feign调用")]),s._v(" "),n("p",[s._v("gulimall-product/src/main/resources/application.yml")])]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("feign")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("sentinel")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("enabled")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("blockquote",[n("p",[s._v("在控制台就可以看到feign远程调用的链路信息")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111133837370","data-src":a(638),loading:"lazy"}})]),s._v(" "),n("h5",{attrs:{id:"_7-1-1-2-编写熔断方法的具体实现"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-1-2-编写熔断方法的具体实现"}},[s._v("#")]),s._v(" 7.1.1.2 编写熔断方法的具体实现")]),s._v(" "),n("blockquote",[n("p",[s._v("熔断方法的具体实现，也可以是降级方法的具体实现")]),s._v(" "),n("p",[s._v("gulimall-product/src/main/java/site/zhourui/gulimall/product/fallback/SeckillFeignServiceFallBack.java")])]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("site"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("zhourui"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gulimall"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("product"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fallback")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("lombok"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("extern"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("slf4j"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Slf4j")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stereotype"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Component")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("site"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("zhourui"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("common"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("exception"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BizCodeEnume")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("site"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("zhourui"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("common"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("utils"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("R")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("site"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("zhourui"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gulimall"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("product"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("feign"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SeckillFeignService")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n * 熔断方法的具体实现，也可以是降级方法的具体实现\n * @author zr\n * @date 2022/1/11 11:50\n */")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Component")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Slf4j")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SeckillFeignServiceFallBack")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("implements")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SeckillFeignService")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("R")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getSkuSeckilInfo")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Long")]),s._v(" skuId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        log"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"熔断方法调用...getSkuSeckilInfo"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("R")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BizCodeEnume")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("TO_MANY_REQUEST"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getCode")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BizCodeEnume")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("TO_MANY_REQUEST"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getMsg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("h5",{attrs:{id:"_7-1-1-3-远程接口指定熔断后的本地默认实现"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-1-3-远程接口指定熔断后的本地默认实现"}},[s._v("#")]),s._v(" 7.1.1.3 远程接口指定熔断后的本地默认实现")]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111134914459","data-src":a(639),loading:"lazy"}})]),s._v(" "),n("blockquote",[n("p",[s._v("gulimall-product/src/main/java/site/zhourui/gulimall/product/feign/SeckillFeignService.java")])]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("site"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("zhourui"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gulimall"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("product"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("feign")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cloud"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("openfeign"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FeignClient")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("web"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bind"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("annotation"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("GetMapping")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("web"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bind"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("annotation"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("PathVariable")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("site"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("zhourui"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("common"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("utils"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("R")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("site"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("zhourui"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gulimall"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("product"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fallback"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SeckillFeignServiceFallBack")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n * @author zr\n * @date 2022/1/9 17:15\n */")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@FeignClient")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("value "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"gulimall-seckill"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("fallback "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SeckillFeignServiceFallBack")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("interface")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SeckillFeignService")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 根据skuId查询商品是否参加秒杀活动\n     * @param skuId\n     * @return\n     */")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@GetMapping")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("value "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/sku/seckill/{skuId}"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("R")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getSkuSeckilInfo")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@PathVariable")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"skuId"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Long")]),s._v(" skuId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])]),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111135148159","data-src":a(640),loading:"lazy"}})]),s._v(" "),n("h5",{attrs:{id:"_7-1-1-4-调用方手动指定远程服务的降级策略"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-1-4-调用方手动指定远程服务的降级策略"}},[s._v("#")]),s._v(" 7.1.1.4 调用方手动指定远程服务的降级策略")]),s._v(" "),n("p",[s._v("7.1.1.4.1 RT")]),s._v(" "),n("blockquote",[n("p",[s._v("RT指定1ms\n如果1S内进来5个请求，每个对应的平均响应时间都超过阈值1ms，则在接下来的10s内会熔断该资源\n并且回调本地的熔断回调方法")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111135306526","data-src":a(641),loading:"lazy"}})]),s._v(" "),n("h5",{attrs:{id:"_7-1-1-5-测试熔断"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-1-5-测试熔断"}},[s._v("#")]),s._v(" 7.1.1.5 测试熔断")]),s._v(" "),n("blockquote",[n("p",[s._v("疯狂刷新商品详情页(模拟高并发),直到控制台出现熔断日志后停止,大概在10s后再次慢速刷新几次(模拟正常访问)")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111135743966","data-src":a(642),loading:"lazy"}})]),s._v(" "),n("h4",{attrs:{id:"_7-1-2-在服务的提供方-远程服务-指定降级策略"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-2-在服务的提供方-远程服务-指定降级策略"}},[s._v("#")]),s._v(" 7.1.2 在服务的提供方（远程服务）指定降级策略")]),s._v(" "),n("blockquote",[n("p",[s._v("超大浏览的时候，必须牺牲一些远程服务。在服务的提供方（远程服务）指定降级策略；")]),s._v(" "),n("p",[s._v("提供方是在运行，但是不允许自己的业务逻辑，返回的是默认的降级数据（限流的数据）")])]),s._v(" "),n("p",[n("strong",[s._v("降级一般是主动【调用自定义返回数据】")])]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[s._v("例如商品详情页查询秒杀商品信息，秒杀系统对资源做了降级处理，返回的是本地默认实现\n\n降级与熔断的区别就是，降级是主动的，提供方未宕机\n\t\t\t\t  熔断是被动的，提供方宕机\n\t\t\t\t  \n因为降级的回调方法与熔断不同，与限流的自定义返回是一致的，所以这里复制"),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SentinelConfig")]),s._v("类给每一个微服务\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h5",{attrs:{id:"_7-1-2-1-对服务提供方进行降级"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-2-1-对服务提供方进行降级"}},[s._v("#")]),s._v(" 7.1.2.1 对服务提供方进行降级")]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111142317907","data-src":a(643),loading:"lazy"}})]),s._v(" "),n("h5",{attrs:{id:"_7-1-2-2-自定义配置降级策略"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-2-2-自定义配置降级策略"}},[s._v("#")]),s._v(" 7.1.2.2 自定义配置降级策略")]),s._v(" "),n("blockquote",[n("p",[s._v("之前配置过就不用配置了")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111142514448","data-src":a(644),loading:"lazy"}})]),s._v(" "),n("h5",{attrs:{id:"_7-1-2-3-测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-2-3-测试"}},[s._v("#")]),s._v(" 7.1.2.3 测试")]),s._v(" "),n("blockquote",[n("p",[s._v("疯狂刷新,模拟大访问量,直到出现降级返回结果")]),s._v(" "),n("p",[s._v("http://seckill.gulimall.com/getCurrentSeckillSkus")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111142726636","data-src":a(645),loading:"lazy"}})]),s._v(" "),n("blockquote",[n("p",[s._v("等待大概10s,再次刷新,服务正常")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111142853347","data-src":a(646),loading:"lazy"}})]),s._v(" "),n("h2",{attrs:{id:"_8-自定义受保护资源"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_8-自定义受保护资源"}},[s._v("#")]),s._v(" 8. 自定义受保护资源")]),s._v(" "),n("h3",{attrs:{id:"_8-1-主流框架的默认适配"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_8-1-主流框架的默认适配"}},[s._v("#")]),s._v(" 8.1 主流框架的默认适配")]),s._v(" "),n("blockquote",[n("p",[s._v("以下资源我们都没有定义,这些就是默认适配的资源")]),s._v(" "),n("p",[s._v("Spring Cloud Alibaba 默认为 Sentinel 整合了 Servlet、RestTemplate、FeignClient 和 Spring WebFlux。Sentinel 在 Spring Cloud 生态中，不仅补全了 Hystrix 在 Servlet 和 RestTemplate 这一块的空白，而且还完全兼容了 Hystrix 在 FeignClient 中限流降级的用法，并且支持运行时灵活地配置和调整限流降级规则")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111143731464","data-src":a(647),loading:"lazy"}})]),s._v(" "),n("h3",{attrs:{id:"_8-2-抛出异常的方式定义资源"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_8-2-抛出异常的方式定义资源"}},[s._v("#")]),s._v(" 8.2 抛出异常的方式定义资源")]),s._v(" "),n("p",[n("code",[s._v("SphU")]),s._v(" 包含了 try-catch 风格的 API。用这种方式，当资源发生了限流之后会抛出 "),n("code",[s._v("BlockException")]),s._v("。这个时候可以捕捉异常，进行限流之后的逻辑处理。示例代码如下:")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1.5.0 版本开始可以利用 try-with-resources 特性")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 资源名可使用任意有业务语义的字符串，比如方法名、接口名或其它可唯一标识的字符串。")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),s._v(" entry "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SphU")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("entry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resourceName"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 被保护的业务逻辑")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// do something here...")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BlockException")]),s._v(" ex"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 资源访问阻止，被限流或被降级")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 在此处进行相应的处理操作")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[n("strong",[s._v("特别地")]),s._v("，若 entry 的时候传入了热点参数，那么 exit 的时候也一定要带上对应的参数（"),n("code",[s._v("exit(count, args")]),s._v(")），否则可能会有统计错误。这个时候不能使用 try-with-resources 的方式。另外通过 "),n("code",[s._v("Tracer.trace(ex)")]),s._v(" 来统计异常信息时，由于 try-with-resources 语法中 catch 调用顺序的问题，会导致无法正确统计异常数，因此统计异常信息时也不能在 try-with-resources 的 catch 块中调用 "),n("code",[s._v("Tracer.trace(ex)")]),s._v("。")]),s._v(" "),n("h4",{attrs:{id:"_8-2-1-测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_8-2-1-测试"}},[s._v("#")]),s._v(" 8.2.1 测试")]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111144630427","data-src":a(648),loading:"lazy"}})]),s._v(" "),n("blockquote",[n("p",[s._v("控制台中展示了我们自定义的受保护资源")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111144540028","data-src":a(649),loading:"lazy"}})]),s._v(" "),n("h3",{attrs:{id:"_8-3-注解方式定义资源"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_8-3-注解方式定义资源"}},[s._v("#")]),s._v(" 8.3 注解方式定义资源")]),s._v(" "),n("p",[n("strong",[s._v("@SentinelResource 注解")])]),s._v(" "),n("blockquote",[n("p",[s._v("注意：注解方式埋点不支持 private 方法。")])]),s._v(" "),n("p",[s._v("@SentinelResource 用于定义资源，并提供可选的异常处理和 fallback 配置项。 @SentinelResource 注解包含以下属性：")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("value：资源名称，必需项（不能为空）")])]),s._v(" "),n("li",[n("p",[s._v("entryType：entry 类型，可选项（默认为 EntryType.OUT）")])]),s._v(" "),n("li",[n("p",[s._v("blockHandler / blockHandlerClass: blockHandler 对应处理 BlockException 的函数名称，可选项。")])]),s._v(" "),n("li",[n("p",[s._v("blockHandler 函数访问范围需要是 public，返回类型需要与原方法相匹配，参数类型需要和原方法相匹配并且最后加一个额外的参数，类型为 BlockException。blockHandler 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 blockHandlerClass 为对应的类的 Class 对象，注意对应的函数必需为 static 函数，否则无法解析。")])]),s._v(" "),n("li",[n("p",[s._v("fallback：fallback 函数名称，可选项，用于在抛出异常的时候提供 fallback 处理逻辑。fallback 函数可以针对所有类型的异常（除了exceptionsToIgnore里面排除掉的异常类型）进行处理。fallback 函数签名和位置要求：\n返回值类型必须与原函数返回值类型一致；\n方法参数列表需要和原函数一致，或者可以额外多一个 Throwable 类型的参数用于接收对应的异常。\nfallback 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 fallbackClass 为对应的类的 Class 对象，注意对应的函数必需为 static 函数，否则无法解析。")])]),s._v(" "),n("li",[n("p",[s._v("defaultFallback（since 1.6.0）：默认的 fallback 函数名称，可选项，通常用于通用的 fallback 逻辑（即可以用于很多服务或方法）。默认 fallback 函数可以针对所以类型的异常（除了exceptionsToIgnore里面排除掉的异常类型）进行处理。若同时配置了 fallback 和 defaultFallback，则只有 fallback 会生效。defaultFallback 函数签名要求：")]),s._v(" "),n("p",[s._v("返回值类型必须与原函数返回值类型一致；\n方法参数列表需要为空，或者可以额外多一个 Throwable 类型的参数用于接收对应的异常。\ndefaultFallback 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 fallbackClass 为对应的类的 Class 对象，注意对应的函数必需为 static 函数，否则无法解析。\nexceptionsToIgnore（since 1.6.0）：用于指定哪些异常被排除掉，不会计入异常统计中，也不会进入 fallback 逻辑中，而是会原样抛出。")])])]),s._v(" "),n("blockquote",[n("p",[s._v("注：1.6.0 之前的版本 fallback 函数只针对降级异常（"),n("code",[s._v("DegradeException")]),s._v("）进行处理，"),n("strong",[s._v("不能针对业务异常进行处理")]),s._v("。")])]),s._v(" "),n("p",[s._v("特别地，若 blockHandler 和 fallback 都进行了配置，则被限流降级而抛出 "),n("code",[s._v("BlockException")]),s._v(" 时只会进入 "),n("code",[s._v("blockHandler")]),s._v(" 处理逻辑。若未配置 "),n("code",[s._v("blockHandler")]),s._v("、"),n("code",[s._v("fallback")]),s._v(" 和 "),n("code",[s._v("defaultFallback")]),s._v("，则被限流降级时会将"),n("code",[s._v("BlockException")]),s._v(" 直接抛出。")]),s._v(" "),n("p",[s._v("示例：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("TestService")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 对应的 `handleException` 函数需要位于 `ExceptionUtil` 类中，并且必须为 static 函数.")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@SentinelResource")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("value "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" blockHandler "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"handleException"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" blockHandlerClass "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ExceptionUtil")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("test")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Test"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 原函数")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@SentinelResource")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("value "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" blockHandler "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"exceptionHandler"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" fallback "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"helloFallback"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("hello")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("format")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Hello at %d"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    \n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Fallback 函数，函数签名与原函数一致或加一个 Throwable 类型的参数.")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("helloFallback")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("format")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Halooooo %d"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Block 异常处理函数，参数最后多一个 BlockException，其余与原函数一致.")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("exceptionHandler")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BlockException")]),s._v(" ex"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Do some log here.")]),s._v("\n        ex"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("printStackTrace")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Oops, error occurred at "')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br")])]),n("p",[s._v("从 1.4.0 版本开始，注解方式定义资源支持自动统计业务异常，无需手动调用 "),n("code",[s._v("Tracer.trace(ex)")]),s._v(" 来记录业务异常。Sentinel 1.4.0 以前的版本需要自行调用 "),n("code",[s._v("Tracer.trace(ex)")]),s._v(" 来记录业务异常。")]),s._v(" "),n("h4",{attrs:{id:"_3-3-1-测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-1-测试"}},[s._v("#")]),s._v(" 3.3.1 测试")]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111150126016","data-src":a(650),loading:"lazy"}})]),s._v(" "),n("blockquote",[n("p",[s._v("加上"),n("code",[s._v("@SentinelResource")]),s._v("后就被找到了")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111145603206","data-src":a(651),loading:"lazy"}})]),s._v(" "),n("h4",{attrs:{id:"_3-3-2-自定义保护资源限流后报错问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-2-自定义保护资源限流后报错问题"}},[s._v("#")]),s._v(" 3.3.2 自定义保护资源限流后报错问题")]),s._v(" "),n("blockquote",[n("p",[s._v("对自定义保护资源限流")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111150506291","data-src":a(652),loading:"lazy"}})]),s._v(" "),n("blockquote",[n("p",[s._v("疯狂刷新,出现以下错误")]),s._v(" "),n("p",[s._v("http://seckill.gulimall.com/getCurrentSeckillSkus")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111150615027","data-src":a(653),loading:"lazy"}})]),s._v(" "),n("h5",{attrs:{id:"_3-3-2-1-解决方案-设置blockhandler"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-2-1-解决方案-设置blockhandler"}},[s._v("#")]),s._v(" 3.3.2.1 解决方案(设置blockHandler)")]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111151018564","data-src":a(654),loading:"lazy"}})]),s._v(" "),n("blockquote",[n("p",[s._v("再次限流测试")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111151049596","data-src":a(655),loading:"lazy"}})]),s._v(" "),n("h3",{attrs:{id:"_8-4-注意-以上三种方式一定要配置被限流后的默认返回-sentinelconfig"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_8-4-注意-以上三种方式一定要配置被限流后的默认返回-sentinelconfig"}},[s._v("#")]),s._v(" 8.4 注意(以上三种方式一定要配置被限流后的默认返回) SentinelConfig")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n * @author zr\n * @date 2022/1/11 10:40\n */")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Configuration")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SentinelConfig")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SeckillSentinelConfig")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("WebCallbackManager")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setUrlBlockHandler")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UrlBlockHandler")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("blocked")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HttpServletRequest")]),s._v(" httpServletRequest"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HttpServletResponse")]),s._v(" httpServletResponse"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BlockException")]),s._v(" e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IOException")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("R")]),s._v(" error "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("R")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BizCodeEnume")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("TO_MANY_REQUEST"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getCode")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BizCodeEnume")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("TO_MANY_REQUEST"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getMsg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                httpServletResponse"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setCharacterEncoding")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"UTF-8"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                httpServletResponse"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setContentType")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"application/json"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                httpServletResponse"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getWriter")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("JSON"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("toJSONString")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("h2",{attrs:{id:"_9-网关控流"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_9-网关控流"}},[s._v("#")]),s._v(" 9. 网关控流")]),s._v(" "),n("p",[s._v("Sentinel 支持对 Spring Cloud Gateway、Zuul 等主流的 API Gateway 进行限流。")]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"https://user-images.githubusercontent.com/9434884/58381714-266d7980-7ff3-11e9-8617-d0d7c325d703.png","data-src":a(656),loading:"lazy"}})]),s._v(" "),n("p",[s._v("Sentinel 1.6.0 引入了 Sentinel API Gateway Adapter Common 模块，此模块中包含网关限流的规则和自定义 API 的实体和管理逻辑：")]),s._v(" "),n("p",[s._v("GatewayFlowRule：网关限流规则，针对 API Gateway 的场景定制的限流规则，可以针对不同 route 或自定义的 API 分组进行限流，支持针对请求中的参数、Header、来源 IP 等进行定制化的限流。\nApiDefinition：用户自定义的 API 定义分组，可以看做是一些 URL 匹配的组合。比如我们可以定义一个 API 叫 my_api，请求 path 模式为 /foo/** 和 /baz/** 的都归到 my_api 这个 API 分组下面。限流的时候可以针对这个自定义的 API 分组维度进行限流。\n其中网关限流规则 GatewayFlowRule 的字段解释如下：")]),s._v(" "),n("p",[s._v("resource：资源名称，可以是网关中的 route 名称或者用户自定义的 API 分组名称。\nresourceMode：规则是针对 API Gateway 的 route（RESOURCE_MODE_ROUTE_ID）还是用户在 Sentinel 中定义的 API 分组（RESOURCE_MODE_CUSTOM_API_NAME），默认是 route。\ngrade：限流指标维度，同限流规则的 grade 字段。\ncount：限流阈值\nintervalSec：统计时间窗口，单位是秒，默认是 1 秒。\ncontrolBehavior：流量整形的控制效果，同限流规则的 controlBehavior 字段，目前支持快速失败和匀速排队两种模式，默认是快速失败。\nburst：应对突发请求时额外允许的请求数目。\nmaxQueueingTimeoutMs：匀速排队模式下的最长排队时间，单位是毫秒，仅在匀速排队模式下生效。\nparamItem：参数限流配置。若不提供，则代表不针对参数进行限流，该网关规则将会被转换成普通流控规则；否则会转换成热点规则。其中的字段：\nparseStrategy：从请求中提取参数的策略，目前支持提取来源 IP（PARAM_PARSE_STRATEGY_CLIENT_IP）、Host（PARAM_PARSE_STRATEGY_HOST）、任意 Header（PARAM_PARSE_STRATEGY_HEADER）和任意 URL 参数（PARAM_PARSE_STRATEGY_URL_PARAM）四种模式。\nfieldName：若提取策略选择 Header 模式或 URL 参数模式，则需要指定对应的 header 名称或 URL 参数名称。\npattern：参数值的匹配模式，只有匹配该模式的请求属性值会纳入统计和流控；若为空则统计该请求属性的所有值。（1.6.2 版本开始支持）\nmatchStrategy：参数值的匹配策略，目前支持精确匹配（PARAM_MATCH_STRATEGY_EXACT）、子串匹配（PARAM_MATCH_STRATEGY_CONTAINS）和正则匹配（PARAM_MATCH_STRATEGY_REGEX）。（1.6.2 版本开始支持）\n用户可以通过 GatewayRuleManager.loadRules(rules) 手动加载网关规则，或通过 GatewayRuleManager.register2Property(property) 注册动态规则源动态推送（推荐方式）。")]),s._v(" "),n("h3",{attrs:{id:"_9-1-为什么要网关控流"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_9-1-为什么要网关控流"}},[s._v("#")]),s._v(" 9.1 为什么要网关控流?")]),s._v(" "),n("p",[n("strong",[s._v("如果能在网关层就进行流控，可以避免请求流入业务，减小服务压力")])]),s._v(" "),n("h3",{attrs:{id:"_9-2-为网关服务整合网关流控"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_9-2-为网关服务整合网关流控"}},[s._v("#")]),s._v(" 9.2 为网关服务整合网关流控")]),s._v(" "),n("h4",{attrs:{id:"_9-2-1-导入依赖"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_9-2-1-导入依赖"}},[s._v("#")]),s._v(" 9.2.1 导入依赖")]),s._v(" "),n("blockquote",[n("p",[s._v("gulimall-gateway/pom.xml")])]),s._v(" "),n("div",{staticClass:"language-pom line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("        \x3c!-- 引入sentinel网关限流 --\x3e\n        <dependency>\n            <groupId>com.alibaba.cloud</groupId>\n            <artifactId>spring-cloud-alibaba-sentinel-gateway</artifactId>\n            <version>2.1.0.RELEASE</version>\n        </dependency>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h4",{attrs:{id:"_9-2-2-配置网关限流"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_9-2-2-配置网关限流"}},[s._v("#")]),s._v(" 9.2.2 配置网关限流")]),s._v(" "),n("blockquote",[n("p",[s._v("此处需要安装sentinel1.7.1.jar客户端才能看到效果")])]),s._v(" "),n("blockquote",[n("p",[s._v("对gulimall_seckill_route进行限制")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111160614858","data-src":a(657),loading:"lazy"}})]),s._v(" "),n("blockquote",[n("p",[s._v("疯狂访问http://seckill.gulimall.com/getCurrentSeckillSkus测试")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111155930331","data-src":a(658),loading:"lazy"}})]),s._v(" "),n("h4",{attrs:{id:"_9-2-3-针对请求属性限流"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_9-2-3-针对请求属性限流"}},[s._v("#")]),s._v(" 9.2.3 针对请求属性限流")]),s._v(" "),n("blockquote",[n("p",[s._v("开启针对参数属性限流")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111161026514","data-src":a(659),loading:"lazy"}})]),s._v(" "),n("h4",{attrs:{id:"_9-2-4-定制网关流控返回"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_9-2-4-定制网关流控返回"}},[s._v("#")]),s._v(" 9.2.4 定制网关流控返回")]),s._v(" "),n("blockquote",[n("p",[s._v("gulimall-gateway/src/main/java/site/zhourui/gulimall/gateway/config/SentinelGatewayConfig.java")])]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("site"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("zhourui"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gulimall"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gateway"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("config")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("csp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sentinel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("adapter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gateway"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("callback"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BlockRequestHandler")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("csp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sentinel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("adapter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gateway"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("callback"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("GatewayCallbackManager")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("alibaba"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fastjson"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("JSON"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stereotype"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Component")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("web"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("reactive"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("function"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("server"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ServerResponse")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("web"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("server"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ServerWebExchange")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("reactor"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("core"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("publisher"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Mono")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("site"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("zhourui"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("common"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("exception"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BizCodeEnume")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("site"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("zhourui"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("common"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("utils"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("R")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n * 自定义阻塞返回方法\n * @author zr\n * @date 2022/1/11 16:30\n */")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Component")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SentinelGatewayConfig")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// TODO 响应式编程")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SentinelGatewayConfig")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("GatewayCallbackManager")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setBlockHandler")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BlockRequestHandler")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 网关限流了请求，就会调用此回调")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Mono")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ServerResponse")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("handleRequest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ServerWebExchange")]),s._v(" serverWebExchange"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Throwable")]),s._v(" throwable"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("R")]),s._v(" error "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("R")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BizCodeEnume")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("TO_MANY_REQUEST"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getCode")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BizCodeEnume")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("TO_MANY_REQUEST"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getMsg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" errJson "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" JSON"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("toJSONString")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ServerResponse")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ok")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("body")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Mono")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("just")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("errJson"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br")])]),n("blockquote",[n("p",[s._v("测试结果")])]),s._v(" "),n("p",[n("img",{staticClass:"lazy",attrs:{alt:"image-20220111163442601","data-src":a(660),loading:"lazy"}})])])}),[],!1,null,null,null);t.default=e.exports},625:function(s,t,a){s.exports=a.p+"assets/img/590075a1ce0b0efdf18f9107db129e55.ca19a14f.png"},626:function(s,t,a){s.exports=a.p+"assets/img/5086dc1e0b09e618bec059cb9a1a64ba.ea5ebc23.png"},627:function(s,t,a){s.exports=a.p+"assets/img/c69e4f9b854e9a054085f1a2ba6d6e2c.f2f8c25b.png"},628:function(s,t,a){s.exports=a.p+"assets/img/9c0c260131fe452771802df5978ea2db.0667a1a6.png"},629:function(s,t,a){s.exports=a.p+"assets/img/3e6c8c8a3c7b7fe8f3b88371f2423c77.c321f9b3.png"},630:function(s,t,a){s.exports=a.p+"assets/img/40f73f1c8d3ab26dcc58cfba2a069279.358eccb5.png"},631:function(s,t,a){s.exports=a.p+"assets/img/e3a12ee5182daa18d387f3272c728743.adacd4fa.png"},632:function(s,t,a){s.exports=a.p+"assets/img/06ea0d11bd9608ca7979a30aff37063a.cd4c492c.png"},633:function(s,t,a){s.exports=a.p+"assets/img/fffbcd5a429dce6d56989ec578eedad5.2763108a.png"},634:function(s,t,a){s.exports=a.p+"assets/img/5ee51763668b74e88e5e0ec1c088e197.bef12888.png"},635:function(s,t,a){s.exports=a.p+"assets/img/94c3c52d2c7248624a049223e4d99df2.bf7b9bd4.png"},636:function(s,t,a){s.exports=a.p+"assets/img/4a5d15e9b86cfe770a11d5c74e4cf0ee.94efd965.png"},637:function(s,t,a){s.exports=a.p+"assets/img/a257033ba07a48551ab168b206dca931.662ee098.png"},638:function(s,t,a){s.exports=a.p+"assets/img/670db632b3c896cb814e9df0e6ea3a27.1365fd1a.png"},639:function(s,t,a){s.exports=a.p+"assets/img/26a723ce4e33374453252a8533362883.8e369ec5.png"},640:function(s,t,a){s.exports=a.p+"assets/img/0a1efb772b43f1dd63df6a6e13cc3e23.20fd7baa.png"},641:function(s,t,a){s.exports=a.p+"assets/img/af8fd077f236bbb35f28158069fcf328.4f25ca16.png"},642:function(s,t,a){s.exports=a.p+"assets/img/684c01d1d638657b9999b3137f155449.5fc73c8d.png"},643:function(s,t,a){s.exports=a.p+"assets/img/10ea7ca2be835aee57e55897d4d0ff4e.d4295c4e.png"},644:function(s,t,a){s.exports=a.p+"assets/img/c436cbf2fb8daebfca8fda81a8377d49.0ed00a68.png"},645:function(s,t,a){s.exports=a.p+"assets/img/e5b588de79a4fe5c5fb414af4e9c0f25.32abed70.png"},646:function(s,t,a){s.exports=a.p+"assets/img/ae290d5a90eab287411f55095484f0e2.99434a76.png"},647:function(s,t,a){s.exports=a.p+"assets/img/e4ae91d42d1d7aac5367e5b856b00850.c4e5a21b.png"},648:function(s,t,a){s.exports=a.p+"assets/img/e2a227b4e5f14c4535c2b146c79a40f4.00497a78.png"},649:function(s,t,a){s.exports=a.p+"assets/img/04f864b480ebace7994a8547041ccf66.62ac1737.png"},650:function(s,t,a){s.exports=a.p+"assets/img/d96ab14ddf4a5ef33e1a7439b03a24bc.a4f2bb5f.png"},651:function(s,t,a){s.exports=a.p+"assets/img/182f227d0a5d14e04e8b9e2a1323aea7.91631f24.png"},652:function(s,t,a){s.exports=a.p+"assets/img/ea37894ebb8586a735940e8acb37320d.42081eb1.png"},653:function(s,t,a){s.exports=a.p+"assets/img/48ac49657193d318474ea39c0991e61f.49210d91.png"},654:function(s,t,a){s.exports=a.p+"assets/img/46996013b4a2386c203f847d19d7a7eb.51258f1b.png"},655:function(s,t,a){s.exports=a.p+"assets/img/7118487ac9267f941a8998b6548390a8.70a6a98b.png"},656:function(s,t,a){s.exports=a.p+"assets/img/4f9fbe909aef992b3c239d7983366682.e7dedcb9.png"},657:function(s,t,a){s.exports=a.p+"assets/img/ae75db120df5f5777ce7c8b7cc124a22.9b049583.png"},658:function(s,t,a){s.exports=a.p+"assets/img/68c1f16940c5bc397b481dee7b3ee6a0.93d57818.png"},659:function(s,t,a){s.exports=a.p+"assets/img/1ab6478584061940fcefdb964e386e17.f758a608.png"},660:function(s,t,a){s.exports=a.p+"assets/img/cb5073ebbb4eaf1d1b51c770bf191aa4.1b78be0f.png"}}]);